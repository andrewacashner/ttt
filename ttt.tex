\input cwebmac
% ttt.w -- Tic tac toe game in CWEB, Copyright (c) 2015 Andrew A. Cashner
% 2015-05-26


\N{1}{1}Introduction. This is \.{ttt}, a command-line tic-tac-toe game.
% TODO more

\Y\B\8\#\&{include} \.{<stdio.h>}\6
\8\#\&{include} \.{<stdlib.h>}\6
\8\#\&{include} \.{<string.h>}\6
\X2:Global variables\X\7
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\.{FALSE},\39\.{TRUE}{}$\2\6
${}\}{}$ \&{boolean};\7
\X14:Function prototypes\X\7
\&{int} \\{main}(\&{int} \\{argc}${},\39{}$\&{char} ${}{*}\\{argv}[\,]){}$\1\1%
\2\2\6
${}\{{}$\1\6
\X4:Main variables\X\7
\&{boolean} \\{gameover};\7
${}\\{gameover}\K\.{FALSE};{}$\6
\X3:Process command-line options\X\6
\X12:Populate switching tables\X\6
${}\\{printf}(\.{"\%s\\n"},\39\\{greeting});{}$\6
\X13:Draw board\X\6
\&{while} ${}(\\{gameover}\E\.{FALSE}){}$\5
${}\{{}$\1\6
\X5:Get O move, update board\X\6
\X16:Process last move\X\6
\X22:Prepare next move\X\6
\4${}\}{}$\2\6
\X29:Gameover routine\X\6
\&{return} (\T{0});\6
\4${}\}{}$\2\par
\fi

\M{2}Error messages.

\Y\B\4\X2:Global variables\X${}\E{}$\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{O\_COMMAND\_OUT\_OF\_RANGE},\39\.{O\_COMMAND\_FAULTY},\39\.{SQUARE\_NOT%
\_EMPTY}{}$\2\6
${}\}{}$ \\{error\_msg}; \&{static} \&{const} \&{char} ${}{*}$ \&{error} [\,] $%
\K$ $\{\.{"That\ square\ is\ not\ }\)\.{on\ the\ board.\ "}\.{"Enter\ A1,\ A2,\
A3,\ B}\)\.{1,\ B2,\ B3,\ C1,\ C2,\ o}\)\.{r\ C3."},\39\.{"I\ don't\ understand%
\ }\)\.{your\ command.\ "}\.{"Enter\ a\ label\ like\ }\)\.{A1\ and\ press\
[ENTER]}\)\.{."},\39\.{"That\ square\ is\ alre}\)\.{ady\ taken.\ Choose\ an}\)%
\.{other."}\};{}$\7
\&{static} \&{const} \&{char} \\{greeting}[\,]${}\K\{\.{"\\nTIC\ TAC\ TOE\\n"}%
\.{"I\ play\ X.\ You\ play\ }\)\.{O.\ You\ go\ first.\\n"}\.{"Use\ one\ of\ the%
\ labe}\)\.{ls\ shown\ below\ to\ sa}\)\.{y\ where\ you\ will\ mov}\)\.{e.\\n"}%
\.{"\\n\ A1\ |\ A2\ |\ A3\ \\n-}\)\.{----------\\n"}\.{"\ B1\ |\ B2\ |\ B3\ %
\\n---}\)\.{--------\\n"}\.{"\ C1\ |\ C2\ |\ C3\\n\\n"}\.{"Let's\ play!"}\}{}$;%
\par
\As7\ET10.
\U1.\fi

\M{3}Process command-line options.
\Y\B\4\X3:Process command-line options\X${}\E{}$\par
\U1.\fi

\M{4}Get user input for O move.

\Y\B\4\D$\.{MAXLINE}$ \5
\T{100}\par
\Y\B\4\X4:Main variables\X${}\E{}$\6
\&{char} \6
\&{line} [\.{MAXLINE}]\1\5
;\2\7
\&{int} \\{nextOmove};\6
\&{int} \\{squares\_filled};\C{ Total squares filled on board }\par
\As8\ET27.
\U1.\fi

\M{5}Check O command for validity and set \PB{\\{nextOmove}}.
The command is entered in the form \.{A1\\n}.
\.{'A'} is 0, \.{'B'} is 3, \.{'C'} is 6.
\.{'A1'} is $0 + 0$, \.{'B2'} is $3 + 1$.

\Y\B\4\X5:Get O move, update board\X${}\E{}$\6
\&{while} (\T{1}) $\{$ \\{printf}(\.{"Your\ move?\\n"}); \\{fgets} ( \&{line}
$,$ \&{sizeof} ( \&{line} ) $,$ \\{stdin} )  ; \&{if} ( \&{line} [\T{2}] $\I$ %
\.{'\\n'} $\V$ \&{line} [\T{0}] $<$ \.{'A'} $\V$ \&{line} [\T{0}] $>$ \.{'C'} $%
\V$ \&{line} [\T{1}] $<$ \.{'1'} $\V$ \&{line} [\T{1}] $>$ \.{'3'} ) $\{$ %
\\{printf} $(\.{"\%s\\n"},\39$ \&{error} [\.{O\_COMMAND\_OUT\_OF\_RANGE}] )  ;\6
\&{continue}; $\}$ \\{nextOmove} $\K$ ( \&{line} [\T{0}] ${-}\.{'A'}$ ) ${*}%
\T{3};$ \\{nextOmove} $\MRL{+{\K}}$ \6
\&{line} [\T{1}]\1\5
${}{-}\.{'1'};{}$\2\6
\&{if} ${}(\\{newmove}(\.{OPLAYER},\39\\{nextOmove},\39\\{gameboard\_ptr},\39%
\\{charboard\_ptr})\E\.{NOTEMPTY})$ $\{$ \\{printf} $(\.{"\%s\\n"},\39$ %
\&{error} [\.{SQUARE\_NOT\_EMPTY}] )  ; $\}$ \6
\&{else}\5
${}\{{}$\1\6
${}\PP\\{squares\_filled};{}$\6
\&{break};\6
\4${}\}{}$\2\6
$\}{}$\par
\U1.\fi

\N{1}{6}Printing the game board.

\fi

\M{7}Switching tables needed to draw the board, and update the drawing.

\Y\B\4\X2:Global variables\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{int} \\{charboard\_index}[\,]${}\K\{\T{2},\39\T{6},\39%
\T{10},\39\T{26},\39\T{30},\39\T{34},\39\T{50},\39\T{54},\39\T{58}\};{}$\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{A1},\39\.{A2},\39\.{A3},\39\.{B1},\39\.{B2},\39\.{B3},\39\.{C1},\39%
\.{C2},\39\.{C3}{}$\2\6
${}\}{}$ \\{squareID};\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{EMPTY},\39\.{XPLAYER},\39\.{OPLAYER}{}$\2\6
${}\}{}$ \\{playerID};\6
\&{static} \&{const} \&{char} \\{playerchar}[\,]${}\K\{\.{'\ '},\39\.{'X'},\39%
\.{'O'}\}{}$;\par
\fi

\M{8}We set up the table within \PB{\\{main}}.
\PB{\\{gameboard}} holds \PB{\&{int}} values for each square of the gameboard,
which is either
\PB{\.{EMPTY}}, \PB{\.{XPLAYER}}, or \PB{\.{OPLAYER}}.
\PB{\\{charboard}} holds the characters to draw the board, and will be updated
as new
squares of \PB{\\{gameboard}} are filled.

\Y\B\4\D$\.{CHAR\_BOARD\_LENGTH}$ \5
\T{62}\par
\Y\B\4\X4:Main variables\X${}\mathrel+\E{}$\6
\&{int} \\{gameboard}[\T{9}]${}\K\{\T{0},\39\T{0},\39\T{0},\39\T{0},\39\T{0},%
\39\T{0},\39\T{0},\39\T{0},\39\T{0}\}{}$;\C{ Start empty }\6
\&{char} \\{charboard}[\,]${}\K\.{"\\n\ \ \ |\ \ \ |\ \ \ \\n"}\.{"-----------%
\\n"}\.{"\ \ \ |\ \ \ |\ \ \ \\n"}\.{"-----------\\n"}\.{"\ \ \ |\ \ \ |\ \ \ %
\\n\\n"};{}$\6
\&{int} ${}{*}\\{gameboard\_ptr}\K\\{gameboard};{}$\6
\&{char} ${}{*}\\{charboard\_ptr}\K\\{charboard}{}$;\par
\fi

\M{9}Switching table with winning series.

\Y\B\4\D$\.{MAXANSWERS}$ \5
\T{8}\par
\B\4\D$\.{NOTFOUND}$ \5
${-}{}$\T{1}\par
\B\4\D$\.{MAXPERMS}$ \5
\T{24}\par
\fi

\M{10}These are all the triples that win the game.

\Y\B\4\X2:Global variables\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{int} \\{answer}[\T{8}][\T{3}]${}\K\{\{\T{0},\39\T{1},%
\39\T{2}\},\39\{\T{0},\39\T{3},\39\T{6}\},\39\{\T{0},\39\T{4},\39\T{8}\},\39\{%
\T{1},\39\T{4},\39\T{7}\},\39\{\T{2},\39\T{4},\39\T{6}\},\39\{\T{2},\39\T{5},%
\39\T{8}\},\39\{\T{3},\39\T{4},\39\T{5}\},\39\{\T{6},\39\T{7},\39\T{8}\}\}{}$;%
\par
\fi

\M{11}Switching tables created in \PB{\\{main}}.
\fi

\M{12}Set up switching table of permutations.
\Y\B\4\X12:Populate switching tables\X${}\E{}$\par
\U1.\fi

\M{13}Draw the board. We simply print \PB{\\{charboard}} to \PB{\\{stdout}}.

\Y\B\4\X13:Draw board\X${}\E{}$\6
$\\{printf}(\.{"\%s"},\39\\{charboard}){}$;\par
\Us1\ET15.\fi

\N{1}{14}Updating the game board.

\Y\B\4\X14:Function prototypes\X${}\E{}$\6
\&{int} \\{newmove}(\&{int} \\{player}${},\39{}$\&{int} \\{square}${},\39{}$%
\&{int} ${}{*}\\{gameboard},\39{}$\&{char} ${}{*}\\{charboard}){}$;\par
\A24.
\U1.\fi

\M{15}The function updates the gameboard with a new move.

\Y\B\4\D$\.{NOTEMPTY}$ \5
${-}{}$\T{10}\par
\Y\B\&{int} \\{newmove}(\&{int} \\{player}${},\39{}$\&{int} \\{square}${},%
\39{}$\&{int} ${}{*}\\{gameboard},\39{}$\&{char} ${}{*}\\{charboard}){}$\1\1\2%
\2\6
${}\{{}$\1\6
\&{if} ${}({*}(\\{gameboard}+\\{square})\I\.{EMPTY}){}$\5
${}\{{}$\1\6
\&{return} (\.{NOTEMPTY});\6
\4${}\}{}$\2\6
${}{*}(\\{gameboard}+\\{square})\K\\{player};{}$\6
${}{*}(\\{charboard}+\\{charboard\_index}[\\{square}])\K\\{playerchar}[%
\\{player}];{}$\6
\X13:Draw board\X\6
\&{return} (\T{0});\6
\4${}\}{}$\2\par
\fi

\M{16}Process the X and O moves of turn just completed.

\Y\B\4\X16:Process last move\X${}\E{}$\6
\X17:Test for win 3/3\X\6
\X18:Update X positions\X\6
\X19:Update O positions\X\6
\X20:Eliminate X wins\X\6
\X21:Eliminate O wins\X\par
\U1.\fi

\M{17}TODO
\Y\B\4\X17:Test for win 3/3\X${}\E{}$\C{ Test X values for 3/3 }\C{ Test O
values for 3/3 }\par
\U16.\fi

\M{18}Update X positions.

\Y\B\4\X18:Update X positions\X${}\E{}$\par
\U16.\fi

\M{19}TODO
\Y\B\4\X19:Update O positions\X${}\E{}$\par
\U16.\fi

\M{20}TODO
\Y\B\4\X20:Eliminate X wins\X${}\E{}$\par
\U16.\fi

\M{21}TODO
\Y\B\4\X21:Eliminate O wins\X${}\E{}$\par
\U16.\fi

\M{22}Prepare the next X move.

\Y\B\4\X22:Prepare next move\X${}\E{}$\6
\X25:Test for X runs 2/3\X\6
\X26:Test for O runs 2/3\X\6
\X28:Choose free spot\X\6
\&{if} ${}(\\{squares\_filled}>\T{8}){}$\5
${}\{{}$\1\6
${}\\{gameover}\K\.{TRUE};{}$\6
\4${}\}{}$\2\par
\U1.\fi

\M{23}Test for two in a row, and if found, return the third member.

\fi

\M{24}Function to test two in a row.

\Y\B\4\X14:Function prototypes\X${}\mathrel+\E{}$\6
\&{int} \\{twoofthree}(\&{int} \\{test}[\,]${},\39{}$\&{int} \\{test\_array%
\_length}${},\39{}$\&{int} \\{perms}[\,][\T{3}]);\par
\fi

\M{25}TODO
\Y\B\4\X25:Test for X runs 2/3\X${}\E{}$\par
\U22.\fi

\M{26}TODO
\Y\B\4\X26:Test for O runs 2/3\X${}\E{}$\par
\U22.\fi

\M{27}Move X to any optimal square.

\Y\B\4\X4:Main variables\X${}\mathrel+\E{}$\6
\&{int} \\{best\_moves}[\,]${}\K\{\.{B2},\39\.{A1},\39\.{A3},\39\.{C1},\39%
\.{C3},\39\.{A2},\39\.{B1},\39\.{B3},\39\.{C2}\};{}$\6
\&{int} \\{total\_best\_moves}${}\K\T{8};{}$\6
\&{int} \|i;\par
\fi

\M{28}Loop through list of optimal squares and select one that is not occupied.

\Y\B\4\X28:Choose free spot\X${}\E{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{total\_best\_moves};{}$ ${}\PP\|i){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{newmove}(\.{XPLAYER},\39\\{best\_moves}[\|i],\39\\{gameboard%
\_ptr},\39\\{charboard\_ptr})\I\.{NOTEMPTY}){}$\1\5
\&{break};\2\6
\4${}\}{}$\2\6
${}\PP\\{squares\_filled}{}$;\par
\U22.\fi

\N{1}{29}Game-over routine.
\Y\B\4\X29:Gameover routine\X${}\E{}$\6
\\{printf}(\.{"Game\ over!\\n"});\par
\U1.\fi

\inx
\fin
\con
