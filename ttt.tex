\input cwebmac
% ttt.w -- Tic tac toe game in CWEB, Copyright (c) 2015 Andrew A. Cashner
% 2015-05-26


\N{1}{1}Introduction. This is \.{ttt}, a command-line tic-tac-toe game.
% TODO more

\Y\B\8\#\&{include} \.{<stdio.h>}\6
\8\#\&{include} \.{<stdlib.h>}\6
\8\#\&{include} \.{<string.h>}\6
\X5:Global variables\X\7
\&{typedef} \&{enum} ${}\{{}$\1\6
${}\.{FALSE},\39\.{TRUE}{}$\2\6
${}\}{}$ \&{boolean};\7
\X7:Function prototypes\X\7
\&{int} \\{main}(\&{int} \\{argc}${},\39{}$\&{char} ${}{*}\\{argv}[\,]){}$\1\1%
\2\2\6
${}\{{}$\1\6
\X3:Main variables\X\7
\&{boolean} \\{gameover};\7
${}\\{gameover}\K\.{FALSE};{}$\6
\X2:Process command-line options\X\6
\X15:Populate switching tables\X\6
${}\\{printf}(\.{"\%s\\n"},\39\\{greeting});{}$\6
\X16:Draw board\X\6
\&{while} ${}(\\{gameover}\E\.{FALSE}){}$\5
${}\{{}$\1\6
\X4:Get O move, update board\X\6
\X19:Process last move\X\6
\X25:Prepare next move\X\6
\4${}\}{}$\2\6
\X34:Gameover routine\X\6
\&{return} (\T{0});\6
\4${}\}{}$\2\par
\fi

\M{2}Process command-line options.
\Y\B\4\X2:Process command-line options\X${}\E{}$\par
\U1.\fi

\M{3}Get user input for O move.

\Y\B\4\D$\.{MAXLINE}$ \5
\T{100}\par
\Y\B\4\X3:Main variables\X${}\E{}$\6
\&{char} \\{input\_line}[\.{MAXLINE}];\6
\&{int} \\{nextOmove};\6
\&{int} \\{squares\_filled};\C{ Total squares filled on board }\7
${}\\{square\_ptr}\\{listOmoves}\K\NULL{}$;\par
\As12\ET30.
\U1.\fi

\M{4}Check O command for validity and set \PB{\\{nextOmove}}.
The command is entered in the form \.{A1\\n}.
\.{'A'} is 0, \.{'B'} is 3, \.{'C'} is 6.
\.{'A1'} is $0 + 0$, \.{'B2'} is $3 + 1$.

\Y\B\4\X4:Get O move, update board\X${}\E{}$\6
\&{while} (\T{1}) $\{{}$\7
\\{printf}(\.{"\\nYour\ move?\\n"});\6
${}\\{fgets}(\\{input\_line},\39{}$\&{sizeof} (\\{input\_line})${},\39%
\\{stdin}){}$;\7
\&{if} ${}(\\{input\_line}[\T{2}]\I\.{'\\n'}\V\\{input\_line}[\T{0}]<\.{'A'}\V%
\\{input\_line}[\T{0}]>\.{'C'}\V\\{input\_line}[\T{1}]<\.{'1'}\V\\{input%
\_line}[\T{1}]>\.{'3'})$ $\{$ \\{printf} $(\.{"\%s\\n"},\39$ \&{error} [\.{O%
\_COMMAND\_OUT\_OF\_RANGE}] )  ;\5
\&{continue}; $\}{}$\7
$\\{nextOmove}\K(\\{input\_line}[\T{0}]-\.{'A'})*\T{3};{}$\6
${}\\{nextOmove}\MRL{+{\K}}\\{input\_line}[\T{1}]-\.{'1'};$ \6
\&{if} ${}(\\{newmove}(\.{OPLAYER},\39\\{nextOmove},\39\\{gameboard\_ptr},\39%
\\{charboard\_ptr})\I\.{OCCUPIED}){}$\5
${}\{{}$\1\6
${}\PP\\{squares\_filled};{}$\6
${}\\{listOmoves}\K\\{insert\_sorted}(\\{listOmoves},\39\\{nextOmove});{}$\6
\\{printf}(\.{"O\ moves:\ "});\6
\\{print\_movelist}(\\{listOmoves});\6
\&{break};\6
\4${}\}{}$\2\6
\&{else} $\{$ \\{printf} $(\.{"\%s\\n"},\39$ \&{error} [\.{SQUARE\_OCCUPIED}] )
 ; $\}{}$\7
$\}{}$\par
\U1.\fi

\M{5}Insert new moves into list of moves for a particular player, keeping list
sorted in ascending order.

\Y\B\4\X5:Global variables\X${}\E{}$\6
\&{typedef} \&{struct} \\{square} ${}{*}\&{square\_ptr};{}$\6
\&{typedef} \&{struct} \&{square} ${}\{{}$\1\6
\&{int} \\{position};\6
\&{square\_ptr} \\{next};\2\6
${}\}{}$ \&{square};\par
\As10, 13\ETs35.
\U1.\fi

\M{6}Function to insert items into linked list.

\Y\B\&{square\_ptr} \\{insert\_sorted}(\&{square\_ptr} \\{head}${},\39{}$%
\&{int} \\{new\_position})\1\1\2\2\6
${}\{{}$\1\6
\&{square\_ptr} \\{list};\6
\&{square\_ptr} \\{new\_square}${}\K\\{malloc}(\&{sizeof}(\&{square\_ptr}));{}$%
\7
${}\\{new\_square}\MG\\{position}\K\\{new\_position};{}$\6
${}\\{new\_square}\MG\\{next}\K\NULL{}$;\C{ Create new list if there is none }\6
\&{if} ${}(\\{head}\E\NULL){}$\5
${}\{{}$\1\6
${}\\{list}\K\\{new\_square};{}$\6
\&{return} (\\{list});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{list}\K\\{head};{}$\6
\4${}\}{}$\C{ If new position is less, put at head of list and return head }\2\6
\&{if} ${}(\\{new\_position}<\\{list}\MG\\{position}){}$\5
${}\{{}$\1\6
${}\\{new\_square}\MG\\{next}\K\\{list};{}$\6
\&{return} (\\{new\_square});\6
\4${}\}{}$\C{ Loop through to find mid-list insertion point }\2\6
\&{while} ${}(\\{list}\MG\\{next}\I\NULL){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{new\_position}<(\\{list}\MG\\{next})\MG\\{position}){}$\5
${}\{{}$\C{ Insert the node mid-list, here }\1\6
${}\\{new\_square}\MG\\{next}\K\\{list}\MG\\{next};{}$\6
${}\\{list}\MG\\{next}\K\\{new\_square};{}$\6
\&{return} (\\{head});\6
\4${}\}{}$\2\6
\&{else}\5
${}\{{}$\1\6
${}\\{list}\K\\{list}\MG\\{next};{}$\6
\4${}\}{}$\2\6
\4${}\}{}$\C{ If node is greatest of all, add it to end of list }\2\6
${}\\{list}\MG\\{next}\K\\{new\_square};{}$\6
${}\\{new\_square}\MG\\{next}\K\NULL{}$;\C{ Return head of list }\6
\&{return} (\\{head});\6
\4${}\}{}$\2\par
\fi

\M{7}\B\X7:Function prototypes\X${}\E{}$\6
\&{square\_ptr} \\{insert\_sorted}(\&{square\_ptr} \\{head}${},\39{}$\&{int} %
\\{new\_position});\par
\As17, 27\ETs33.
\U1.\fi

\N{1}{8}Printing the game board.

\fi

\M{9}Set up switching tables needed to draw the board, and update the drawing.

\fi

\M{10}\B\X5:Global variables\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{int} \\{charboard\_index}[\,]${}\K\{\T{2},\39\T{6},\39%
\T{10},\39\T{26},\39\T{30},\39\T{34},\39\T{50},\39\T{54},\39\T{58}\};{}$\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{A1},\39\.{A2},\39\.{A3},\39\.{B1},\39\.{B2},\39\.{B3},\39\.{C1},\39%
\.{C2},\39\.{C3}{}$\2\6
${}\}{}$ \\{squareID};\6
\&{static} \&{const} \&{char} ${}{*}\\{square\_label}[\,]\K\{\.{"A1"},\39%
\.{"A2"},\39\.{"A3"},\39\.{"B1"},\39\.{"B2"},\39\.{"B3"},\39\.{"C1"},\39%
\.{"C2"},\39\.{"C3"}\};{}$\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{EMPTY},\39\.{XPLAYER},\39\.{OPLAYER}{}$\2\6
${}\}{}$ \\{playerID};\6
\&{static} \&{const} \&{char} \\{playerchar}[\,]${}\K\{\.{'\ '},\39\.{'X'},\39%
\.{'O'}\}{}$;\par
\fi

\M{11}We set up the table within \PB{\\{main}}.
\PB{\\{gameboard}} holds \PB{\&{int}} values for each square of the gameboard,
which is either
\PB{\.{EMPTY}}, \PB{\.{XPLAYER}}, or \PB{\.{OPLAYER}}.
\PB{\\{charboard}} holds the characters to draw the board, and will be updated
as new
squares of \PB{\\{gameboard}} are filled.

\Y\B\4\D$\.{CHAR\_BOARD\_LENGTH}$ \5
\T{62}\par
\fi

\M{12}\B\X3:Main variables\X${}\mathrel+\E{}$\6
\&{int} \\{gameboard}[\T{9}]${}\K\{\T{0},\39\T{0},\39\T{0},\39\T{0},\39\T{0},%
\39\T{0},\39\T{0},\39\T{0},\39\T{0}\}{}$;\C{ Start empty }\6
\&{char} \\{charboard}[\,]${}\K\.{"\\n\ \ \ |\ \ \ |\ \ \ \\n"}\.{"-----------%
\\n"}\.{"\ \ \ |\ \ \ |\ \ \ \\n"}\.{"-----------\\n"}\.{"\ \ \ |\ \ \ |\ \ \ %
\\n\\n"};{}$\6
\&{int} ${}{*}\\{gameboard\_ptr}\K\\{gameboard};{}$\6
\&{char} ${}{*}\\{charboard\_ptr}\K\\{charboard}{}$;\par
\fi

\M{13}Switching table with winning series.
These are all the triples that win the game.

\Y\B\4\D$\.{MAXANSWERS}$ \5
\T{8}\par
\B\4\D$\.{NOTFOUND}$ \5
${-}{}$\T{1}\par
\B\4\D$\.{MAXPERMS}$ \5
\T{24}\par
\Y\B\4\X5:Global variables\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{int} \\{answer}[\T{8}][\T{3}]${}\K\{\{\T{0},\39\T{1},%
\39\T{2}\},\39\{\T{0},\39\T{3},\39\T{6}\},\39\{\T{0},\39\T{4},\39\T{8}\},\39\{%
\T{1},\39\T{4},\39\T{7}\},\39\{\T{2},\39\T{4},\39\T{6}\},\39\{\T{2},\39\T{5},%
\39\T{8}\},\39\{\T{3},\39\T{4},\39\T{5}\},\39\{\T{6},\39\T{7},\39\T{8}\}\}{}$;%
\par
\fi

\M{14}Switching tables created in \PB{\\{main}}.
\fi

\M{15}Set up switching table of permutations.
\Y\B\4\X15:Populate switching tables\X${}\E{}$\par
\U1.\fi

\M{16}Draw the board. We simply print \PB{\\{charboard}} to \PB{\\{stdout}}.

\Y\B\4\X16:Draw board\X${}\E{}$\6
$\\{printf}(\.{"\%s"},\39\\{charboard}){}$;\par
\Us1\ET18.\fi

\N{1}{17}Updating the game board.

\Y\B\4\X7:Function prototypes\X${}\mathrel+\E{}$\6
\&{int} \\{newmove}(\&{int} \\{player}${},\39{}$\&{int} \&{square}${},\39{}$%
\&{int} ${}{*}\\{gameboard},\39{}$\&{char} ${}{*}\\{charboard}){}$;\par
\fi

\M{18}The function updates the gameboard with a new move.

\Y\B\4\D$\.{OCCUPIED}$ \5
${-}{}$\T{10}\par
\Y\B\&{int} \\{newmove}(\&{int} \\{player}${},\39{}$\&{int} \&{square}${},%
\39{}$\&{int} ${}{*}\\{gameboard},\39{}$\&{char} ${}{*}\\{charboard}){}$\1\1 $%
\{$ \&{if} ( $*$ ( \\{gameboard}\1\1 ${+}\&{square}$ ) $\I$ \.{EMPTY} ) \6
${}\{{}$\1\6
\&{return} (\.{OCCUPIED});\6
\4${}\}{}$\2\6
$*$ ( \\{gameboard}\1\1 ${+}\&{square}$ ) $\K$ \\{player};\6
${}{*}(\\{charboard}+\\{charboard\_index}[\&{square}])\K\\{playerchar}[%
\\{player}];{}$\6
\X16:Draw board\X\6
\&{return} (\T{0}); $\}{}$\par
\fi

\M{19}Process the X and O moves of turn just completed.

\Y\B\4\X19:Process last move\X${}\E{}$\6
\X20:Test for win 3/3\X\6
\X21:Update X positions\X\6
\X22:Update O positions\X\6
\X23:Eliminate X wins\X\6
\X24:Eliminate O wins\X\par
\U1.\fi

\M{20}TODO
\Y\B\4\X20:Test for win 3/3\X${}\E{}$\C{ Test X values for 3/3 }\C{ Test O
values for 3/3 }\par
\U19.\fi

\M{21}Update X positions.

\Y\B\4\X21:Update X positions\X${}\E{}$\par
\U19.\fi

\M{22}TODO
\Y\B\4\X22:Update O positions\X${}\E{}$\par
\U19.\fi

\M{23}TODO
\Y\B\4\X23:Eliminate X wins\X${}\E{}$\par
\U19.\fi

\M{24}TODO
\Y\B\4\X24:Eliminate O wins\X${}\E{}$\par
\U19.\fi

\M{25}Prepare the next X move.

\Y\B\4\X25:Prepare next move\X${}\E{}$\6
\X28:Test for X runs 2/3\X\6
\X29:Test for O runs 2/3\X\6
\X31:Choose free spot\X\6
\&{if} ${}(\\{squares\_filled}>\T{8}){}$\5
${}\{{}$\1\6
${}\\{gameover}\K\.{TRUE};{}$\6
\4${}\}{}$\2\par
\U1.\fi

\M{26}Test for two in a row, and if found, return the third member.

\fi

\M{27}Function to test two in a row.

\Y\B\4\X7:Function prototypes\X${}\mathrel+\E{}$\6
\&{int} \\{twoofthree}(\&{int} \\{test}[\,]${},\39{}$\&{int} \\{test\_array%
\_length}${},\39{}$\&{int} \\{perms}[\,][\T{3}]);\par
\fi

\M{28}TODO
\Y\B\4\X28:Test for X runs 2/3\X${}\E{}$\par
\U25.\fi

\M{29}TODO
\Y\B\4\X29:Test for O runs 2/3\X${}\E{}$\par
\U25.\fi

\M{30}Move X to any optimal square.

\Y\B\4\X3:Main variables\X${}\mathrel+\E{}$\6
\&{int} \\{best\_moves}[\,]${}\K\{\.{B2},\39\.{A1},\39\.{A3},\39\.{C1},\39%
\.{C3},\39\.{A2},\39\.{B1},\39\.{B3},\39\.{C2}\};{}$\6
\&{int} \\{total\_best\_moves}${}\K\T{8};{}$\6
\&{int} \|i;\6
\&{square\_ptr} \\{listXmoves}${}\K\NULL{}$;\par
\fi

\M{31}Loop through list of optimal squares and select one that is not occupied.

\Y\B\4\X31:Choose free spot\X${}\E{}$\6
\&{for} ${}(\|i\K\T{0};{}$ ${}\|i<\\{total\_best\_moves};{}$ ${}\PP\|i){}$\5
${}\{{}$\1\6
\&{if} ${}(\\{newmove}(\.{XPLAYER},\39\\{best\_moves}[\|i],\39\\{gameboard%
\_ptr},\39\\{charboard\_ptr})\I\.{OCCUPIED}){}$\5
${}\{{}$\1\6
${}\PP\\{squares\_filled};{}$\6
${}\\{listXmoves}\K\\{insert\_sorted}(\\{listXmoves},\39\\{best\_moves}[%
\|i]);{}$\6
\\{printf}(\.{"X\ moves:\ "});\6
\\{print\_movelist}(\\{listXmoves});\6
\&{break};\6
\4${}\}{}$\2\6
\4${}\}{}$\2\par
\U25.\fi

\M{32}Print current list of moves (for testing purposes only).

\Y\B\&{void} \\{print\_movelist}(\&{square\_ptr} \\{list})\1\1\2\2\6
${}\{{}$\1\6
\&{for} ( ; ${}\\{list}\I\NULL;{}$ ${}\\{list}\K\\{list}\MG\\{next}){}$\5
${}\{{}$\1\6
${}\\{printf}(\.{"\%s\ "},\39\\{square\_label}[\\{list}\MG\\{position}]);{}$\6
\4${}\}{}$\2\6
\\{printf}(\.{"\\n"});\6
\&{return};\6
\4${}\}{}$\2\par
\fi

\M{33}\B\X7:Function prototypes\X${}\mathrel+\E{}$\6
\&{void} \\{print\_movelist}(\&{square\_ptr} \\{list});\par
\fi

\N{1}{34}Game-over routine.
\Y\B\4\X34:Gameover routine\X${}\E{}$\6
\\{printf}(\.{"Game\ over!\\n"});\par
\U1.\fi

\M{35}Error messages.

\Y\B\4\X5:Global variables\X${}\mathrel+\E{}$\6
\&{static} \&{const} \&{enum} ${}\{{}$\1\6
${}\.{O\_COMMAND\_OUT\_OF\_RANGE},\39\.{O\_COMMAND\_FAULTY},\39\.{SQUARE%
\_OCCUPIED}{}$\2\6
${}\}{}$ \\{error\_msg}; \&{static} \&{const} \&{char} ${}{*}$ \&{error} [\,] $%
\K$ $\{\.{"That\ square\ is\ not\ }\)\.{on\ the\ board.\ "}\.{"Enter\ A1,\ A2,\
A3,\ B}\)\.{1,\ B2,\ B3,\ C1,\ C2,\ o}\)\.{r\ C3."},\39\.{"I\ don't\ understand%
\ }\)\.{your\ command.\ "}\.{"Enter\ a\ label\ like\ }\)\.{A1\ and\ press\
[ENTER]}\)\.{."},\39\.{"That\ square\ is\ alre}\)\.{ady\ taken.\ Choose\ an}\)%
\.{other."}\};{}$\7
\&{static} \&{const} \&{char} \\{greeting}[\,]${}\K\{\.{"\\nTIC\ TAC\ TOE\\n"}%
\.{"I\ play\ X.\ You\ play\ }\)\.{O.\ You\ go\ first.\\n"}\.{"Use\ one\ of\ the%
\ labe}\)\.{ls\ shown\ below\ to\ sa}\)\.{y\ where\ you\ will\ mov}\)\.{e.\\n"}%
\.{"\\n\ A1\ |\ A2\ |\ A3\ \\n-}\)\.{----------\\n"}\.{"\ B1\ |\ B2\ |\ B3\ %
\\n---}\)\.{--------\\n"}\.{"\ C1\ |\ C2\ |\ C3\\n\\n"}\.{"Let's\ play!"}\}{}$;%
\par
\fi


\inx
\fin
\con
